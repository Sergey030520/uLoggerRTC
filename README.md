# Hi üëã, I'm Sergey Makarov

![Profile views](https://komarev.com/ghpvc/?username=sergey030520&label=Profile%20views&color=0e75b6&style=flat)

- üî≠ I‚Äôm currently working on [uLoggerRTC](https://github.com/Sergey030520/uLoggerRTC.git)
- üë®‚Äçüíª All of my projects are available at [https://github.com/Sergey030520](https://github.com/Sergey030520)

## Languages and Tools

![C](https://github.com/tandpfun/skill-icons/blob/main/icons/C.svg) 
![CMake](https://github.com/tandpfun/skill-icons/blob/main/icons/CMake-Dark.svg) 
![VSCode](https://github.com/tandpfun/skill-icons/blob/main/icons/VSCode-Dark.svg) 
![Git](https://github.com/tandpfun/skill-icons/blob/main/icons/Git.svg) 

# uLoggerRTC: RTC –ª–æ–≥–≥–µ—Ä –¥–ª—è STM32F407VET6

1. [–û–ø–∏—Å–∞–Ω–∏–µ](#description_project)
2. [–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏](#features_project)
3. [–†–∞–±–æ—Ç–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏](#button_events)
4. [UART Middleware](#uart_middleware)
5. [–°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞](#build_project)
6. [–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ø–ª–∞—Ç—É](#flash_to_board)
7. [–ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã](#example_work_project)
8. [–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ (Log Output)](#log_output)

## –û–ø–∏—Å–∞–Ω–∏–µ <a name="description_project"></a>

–ü—Ä–æ–µ–∫—Ç uLoggerRTC ‚Äî **–ª–æ–≥–≥–µ—Ä –≤—Ä–µ–º–µ–Ω–∏ –∏ –¥–∞—Ç—ã** –Ω–∞ –±–∞–∑–µ STM32F407VET6.  

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞:  

- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω **RTC –ª–æ–≥–≥–µ—Ä**, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–≤–æ–¥–∏—Ç —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è —á–µ—Ä–µ–∑ UART.
- –ö–Ω–æ–ø–∫–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –∏–∑–º–µ–Ω—è—Ç—å –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –≤—Ä—É—á–Ω—É—é.
- –í—Å—Ç—Ä–æ–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π.
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –¥–ª—è –∫–Ω–æ–ø–æ–∫.
- LED-–∏–Ω–¥–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω—ã—Ö –∏ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π.

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏ –¥–∞—Ç—ã —Å –ø–æ–º–æ—â—å—é –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ RTC.
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π —á–µ—Ä–µ–∑ UART (`LOG_INFO`, `LOG_ERROR`, `LOG_DEBUG`, `LOG_WARNING`).
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–µ–º –∏ –¥–∞—Ç–æ–π **–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏**.
- LED-–∏–Ω–¥–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω—ã—Ö –∏ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.
- –¢–∞–π–º–µ—Ä—ã –∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–Ω–æ–ø–æ–∫.

## –†–∞–±–æ—Ç–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ <a name="button_events"></a>

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **—Ç—Ä–∏ –∫–Ω–æ–ø–∫–∏**, –∫–∞–∂–¥–∞—è –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –æ—Ç–¥–µ–ª—å–Ω–æ–º—É –¥–µ–π—Å—Ç–≤–∏—é:  

- **–ö–Ω–æ–ø–∫–∞ 1:** —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–ª–Ω–æ–π –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏.  
- **–ö–Ω–æ–ø–∫–∞ 2:** —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏.  
- **–ö–Ω–æ–ø–∫–∞ 3:** —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–ª—å–∫–æ –¥–∞—Ç—ã.  

–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –ª—é–±—É—é –∫–Ω–æ–ø–∫—É –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç RTC.  

–ö–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ—Ç—Å—è:  

- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º —á–µ—Ä–µ–∑ UART.  
- –ú–∏–≥–∞—é—â–∏–º —Å–≤–µ—Ç–æ–¥–∏–æ–¥–æ–º, —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É—é—â–∏–º –æ–± —É—Å–ø–µ—à–Ω–æ–π –∏–ª–∏ –Ω–µ—É–¥–∞—á–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≤—Ä–µ–º–µ–Ω–∏/–¥–∞—Ç—ã.  

–ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `process_button_events()`, –≥–¥–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –∫–∞–∫–∞—è –∫–Ω–æ–ø–∫–∞ –±—ã–ª–∞ –Ω–∞–∂–∞—Ç–∞, –∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç—ã –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–∏.

## –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ <a name="build_project"></a>

–ü—Ä–æ–µ–∫—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–±–æ—Ä–∫—É —Å –ø–æ–º–æ—â—å—é **CMake**.

–ü—Ä–∏–º–µ—Ä —Å–±–æ—Ä–∫–∏ —á–µ—Ä–µ–∑ CMake (Linux):

```bash
mkdir build
cd build
cmake ..
make
```
–ü—Ä–æ–µ–∫—Ç –±—ã–ª –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ STM32F407VET6 —Å SD-–∫–∞—Ä—Ç–æ–π 8GB. –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã.

## UART Middleware <a name="uart_middleware"></a>

–§–∞–π–ª `middleware/usart_board.c` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ—É–Ω–∫—Ü–∏—é:

```
void init_uart();
```
–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é USART1 –∏ –≤—Å–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ UART:

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ TX/RX –ø–∏–Ω–æ–≤.

–í–∫–ª—é—á–µ–Ω–∏–µ DMA –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö.

–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥–∞—á–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 115200 –±–æ–¥.

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π —á–µ—Ä–µ–∑ LOG_INFO, LOG_ERROR, LOG_DEBUG, LOG_WARNING.

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, UART –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–∏—Å—Ç–µ–º—ã —á–µ—Ä–µ–∑ –≤—ã–∑–æ–≤ init_board().

## –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ø–ª–∞—Ç—É <a name="flash_to_board"></a>

–ù–∞ Linux –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –ø—Ä–æ—à–∏–≤–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É—Ç–∏–ª–∏—Ç—É `st-flash`:

```
sudo apt install stlink-tools
```

–î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—à–∏–≤–∫–∏ –Ω–∞ STM –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç load_stm_data.sh —Å —É—Ç–∏–ª–∏—Ç–æ–π st-flash:
```
./load_stm_data.sh
```

## –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã

```
    int status = init_board();
    RTC_DateTime_Type cur_datetime;
 
    if (status != 0)
    {
        ledOn(13, 1);
        goto error;
    }
    print_clock_frequencies();
    LOG_INFO("–î—Ä–∞–π–≤–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã\r\n");

    init_buttons();
    init_buttons_callbacks();

    while (1)
    {
         if (get_datetime_rtc(&cur_datetime)) {
            LOG_INFO("RTC read error\r\n");
            goto error;
        }

        LOG_INFO("{{year:%d, month:%d, week:%d, day:%d}; {hour:%02d, minute:%02d, sec:%02d}}",
                 cur_datetime.date.year, cur_datetime.date.month, cur_datetime.date.week, cur_datetime.date.day,
                 cur_datetime.time.hour, cur_datetime.time.minute, cur_datetime.time.seconds);

        process_button_events();

        delay_timer(3000);
    }

error:
    while (1)
        ;
    return 0;
```
## –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ (Log Output) <a name="log_output"></a>

–ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥—ë–Ω –ø—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ –ª–æ–≥–æ–≤ –∏–∑ UART.  

- –°—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ `[main.c:120] {{...}}` ‚Äî —ç—Ç–æ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ RTC (–≥–æ–¥, –º–µ—Å—è—Ü, –Ω–µ–¥–µ–ª—è, –¥–µ–Ω—å, —á–∞—Å—ã, –º–∏–Ω—É—Ç—ã, —Å–µ–∫—É–Ω–¥—ã).  
- –°—Ç—Ä–æ–∫–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `[BTN]` –æ–∑–Ω–∞—á–∞—é—Ç **–Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏**, –ø–æ—Å–ª–µ –∫–æ—Ç–æ—Ä–æ–≥–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –¥–∞—Ç–∞ –∏–ª–∏ –≤—Ä–µ–º—è.  

### –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–Ω–æ–ø–æ–∫:
- **–ö–Ω–æ–ø–∫–∞ 1** ‚Üí —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–ª–Ω–æ–π –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏.  
- **–ö–Ω–æ–ø–∫–∞ 2** ‚Üí —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏.  
- **–ö–Ω–æ–ø–∫–∞ 3** ‚Üí —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–ª—å–∫–æ –¥–∞—Ç—ã.  

### –ü—Ä–∏–º–µ—Ä –ª–æ–≥–æ–≤:
```
[main.c:120] {{year:1980, month:1, week:1, day:1}; {hour:00, minute:00, sec:03}}
[main.c:120] {{year:1980, month:1, week:1, day:1}; {hour:00, minute:00, sec:04}}
[main.c:120] {{year:1980, month:1, week:1, day:1}; {hour:00, minute:00, sec:04}}
[main.c:120] {{year:1980, month:1, week:1, day:1}; {hour:00, minute:00, sec:05}}
[main.c:120] {{year:1980, month:1, week:1, day:1}; {hour:00, minute:00, sec:06}}
[main.c:86] [BTN] Set date -> 2025-08-15 (w=1)
[main.c:120] {{year:2085, month:8, week:41, day:15}; {hour:00, minute:00, sec:06}}
[main.c:120] {{year:2085, month:8, week:41, day:15}; {hour:00, minute:00, sec:07}}
[main.c:69] [BTN] Set time -> 07:20:00[main.c:120] {{year:2085, month:8, week:41, day:15}; {hour:07, minute:20, sec:00}}
[main.c:120] {{year:2085, month:8, week:41, day:15}; {hour:07, minute:20, sec:01}}
[main.c:50] [BTN] Set full datetime -> 2025-02-24 (w=1) 10:50:00
[main.c:120] {{year:2025, month:2, week:41, day:24}; {hour:10, minute:50, sec:00}}
```
